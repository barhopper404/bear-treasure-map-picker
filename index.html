<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEAR Guild - Treasure Map Team Picker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // IMPORTANT: Replace this with your Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSZmzTPP43TD36KdccG4rw6P6NJtN2KbWBK8VW_OOHUzC3vE5NkrKN990EKThKAYU1/exec';
        
        // Lucide React icons as simple SVG components
        const Users = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        );
        
        const Shield = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
        );
        
        const Key = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="7.5" cy="15.5" r="5.5"/>
                <path d="m21 2-9.6 9.6"/>
                <path d="m15.5 7.5 3 3L22 7l-3-3"/>
            </svg>
        );
        
        const Heart = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
            </svg>
        );
        
        const Music = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
            </svg>
        );
        
        const Copy = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
            </svg>
        );
        
        const Check = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polyline points="20 6 9 17 4 12"/>
            </svg>
        );

        const RefreshCw = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M21 2v6h-6"/>
                <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                <path d="M3 22v-6h6"/>
                <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
            </svg>
        );

        const Edit = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        );

        const Trash = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            </svg>
        );

        function TreasureMapTeamPicker() {
          const [view, setView] = useState('home');
          const [eventId, setEventId] = useState('');
          const [eventData, setEventData] = useState(null);
          const [characterName, setCharacterName] = useState('');
          const [wantsCaptain, setWantsCaptain] = useState(false);
          const [isLockpicker, setIsLockpicker] = useState(false);
          const [isHealer, setIsHealer] = useState(false);
          const [isBard, setIsBard] = useState(false);
          const [linkCopied, setLinkCopied] = useState(false);
          const [captains, setCaptains] = useState([]);
          const [pickingCaptain, setPickingCaptain] = useState(0);
          const [firstPickerDeferred, setFirstPickerDeferred] = useState(false);
          const [teams, setTeams] = useState({ captain1: [], captain2: [] });
          const [availablePlayers, setAvailablePlayers] = useState([]);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');
          const [editingPlayer, setEditingPlayer] = useState(null);
          const [spinningWheel, setSpinningWheel] = useState(false);
          const [wheelNames, setWheelNames] = useState([]);
          const [currentWheelName, setCurrentWheelName] = useState('');
          const [captainChoiceTimer, setCaptainChoiceTimer] = useState(45);
          const [draftTimer, setDraftTimer] = useState(60);
          const [hasJoined, setHasJoined] = useState(false);
          const [isAutoPicking, setIsAutoPicking] = useState(false);
          const [justDrafted, setJustDrafted] = useState(null);
          const [isDrafting, setIsDrafting] = useState(false);
          const [draftTimerSetting, setDraftTimerSetting] = useState(60);
          const [captainChoiceTimerSetting, setCaptainChoiceTimerSetting] = useState(45);
          const [teamNames, setTeamNames] = useState({ captain1: '', captain2: '' });
          const [editingTeamName, setEditingTeamName] = useState(null);
          const [tempTeamName, setTempTeamName] = useState('');
          const [editingRoles, setEditingRoles] = useState({});
          const [tempRoles, setTempRoles] = useState({});

          // Check for event ID in URL on load
          useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            const eventParam = urlParams.get('event');
            if (eventParam) {
              setEventId(eventParam);
              setView('join');
            }
          }, []);

          // Store character name in localStorage
          useEffect(() => {
            if (characterName) {
              try {
                localStorage.setItem('bearCharacterName', characterName);
              } catch (e) {
                console.log('localStorage not available:', e);
              }
            }
          }, [characterName]);

          // Load character name from localStorage on mount
          useEffect(() => {
            try {
              const savedName = localStorage.getItem('bearCharacterName');
              if (savedName) {
                setCharacterName(savedName);
              }
            } catch (e) {
              console.log('localStorage not available:', e);
            }
          }, []);

          // Poll for updates when in lobby or during draft
          useEffect(() => {
            if ((view === 'lobby' || view === 'captainChoice' || view === 'teamPicking') && eventId) {
              const interval = setInterval(async () => {
                try {
                  const response = await fetch(`${SCRIPT_URL}?eventId=${eventId}`);
                  const result = await response.json();
                  if (result.success && result.eventData) {
                    // Only update if data actually changed
                    const currentDataStr = JSON.stringify(eventData);
                    const newDataStr = JSON.stringify(result.eventData);
                    
                    if (currentDataStr !== newDataStr) {
                      setEventData(result.eventData);
                      
                      // Sync draft state
                      if (result.eventData.started && result.eventData.captains) {
                        setCaptains(result.eventData.captains);
                        
                        // Only update picker if it changed
                        if (result.eventData.currentPicker !== pickingCaptain) {
                          setPickingCaptain(result.eventData.currentPicker || 0);
                        }
                        
                        // Only update teams if they changed
                        const currentTeamsStr = JSON.stringify(teams);
                        const newTeamsStr = JSON.stringify(result.eventData.teams);
                        if (currentTeamsStr !== newTeamsStr && result.eventData.teams) {
                          setTeams(result.eventData.teams);
                        }
                        
                        // Only update available players if they changed
                        const currentAvailableStr = JSON.stringify(availablePlayers);
                        const newAvailableStr = JSON.stringify(result.eventData.availablePlayers);
                        if (currentAvailableStr !== newAvailableStr && result.eventData.availablePlayers) {
                          setAvailablePlayers(result.eventData.availablePlayers);
                        }
                        
                        // Auto-transition views based on event state
                        if (view === 'lobby' && result.eventData.started) {
                          setView('captainChoice');
                        }
                        if (view === 'captainChoice' && result.eventData.deferredFirstPick !== undefined) {
                          setFirstPickerDeferred(result.eventData.deferredFirstPick);
                          if (result.eventData.deferredFirstPick || (result.eventData.teams && (result.eventData.teams.captain1.length > 0 || result.eventData.teams.captain2.length > 0))) {
                            setView('teamPicking');
                          }
                        }
                        if (result.eventData.completed) {
                          setView('complete');
                        }
                      }
                    }
                  }
                } catch (err) {
                  console.error('Error polling for updates:', err);
                }
              }, 3000); // Poll every 3 seconds (increased from 2 to reduce load)
              
              return () => clearInterval(interval);
            }
          }, [view, eventId, eventData, teams, availablePlayers, pickingCaptain]);

          const generateEventId = () => {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
          };

          const createEvent = async () => {
            setLoading(true);
            setError('');
            
            const newEventId = generateEventId();
            const participant = {
              name: characterName,
              wantsCaptain: wantsCaptain,
              lockpicker: isLockpicker,
              healer: isHealer,
              bard: isBard,
              isMarshall: true
            };

            try {
              // Use GET request with parameters instead of POST for better compatibility
              const params = new URLSearchParams({
                action: 'createEvent',
                eventId: newEventId,
                marshall: characterName,
                participantData: JSON.stringify([participant])
              });
              
              const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
              const result = await response.json();
              
              if (result.success) {
                setEventId(newEventId);
                setEventData(result.eventData);
                setView('lobby');
              } else {
                setError('Failed to create event: ' + result.error);
              }
            } catch (err) {
              setError('Error creating event. Please try again. Error: ' + err.message);
              console.error('Create event error:', err);
            } finally {
              setLoading(false);
            }
          };

          const joinEvent = async () => {
            if (hasJoined) {
              setError('You have already joined this event!');
              return;
            }

            setLoading(true);
            setError('');

            const participant = {
              name: characterName,
              wantsCaptain,
              lockpicker: isLockpicker,
              healer: isHealer,
              bard: isBard,
              isMarshall: false
            };

            try {
              // First, fetch the current event to verify it exists and is not locked
              const checkResponse = await fetch(`${SCRIPT_URL}?eventId=${eventId}`);
              const checkResult = await checkResponse.json();
              
              if (!checkResult.success) {
                setError('Event not found: ' + checkResult.error);
                setLoading(false);
                return;
              }

              // Check if event is locked (started)
              if (checkResult.eventData.started) {
                setError('This event has already started and is locked.');
                setLoading(false);
                return;
              }

              // Check for duplicate usernames
              const existingNames = checkResult.eventData.participants.map(p => p.name.toLowerCase());
              if (existingNames.includes(characterName.toLowerCase())) {
                setError('A player with this name has already joined. Please choose a different character name.');
                setLoading(false);
                return;
              }
              
              // Now add the participant
              const params = new URLSearchParams({
                action: 'addParticipant',
                eventId: eventId,
                participantData: JSON.stringify(participant)
              });
              
              const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
              const result = await response.json();
              
              console.log('Join result:', result);
              
              if (result.success) {
                setEventData(result.eventData);
                setHasJoined(true);
                setView('lobby');
              } else {
                setError('Failed to join event: ' + (result.error || 'Unknown error') + (result.debug ? ' - Debug: ' + JSON.stringify(result.debug) : ''));
              }
            } catch (err) {
              setError('Error joining event. Please check the Event ID and try again. Error: ' + err.message);
              console.error('Join event error:', err);
            } finally {
              setLoading(false);
            }
          };

          const copyEventLink = () => {
            const link = `${window.location.origin}${window.location.pathname}?event=${eventId}`;
            navigator.clipboard.writeText(link);
            setLinkCopied(true);
            setTimeout(() => setLinkCopied(false), 2000);
          };

          const spinWheel = (players) => {
            return players[Math.floor(Math.random() * players.length)];
          };

          const animateWheelSpin = (names, callback) => {
            setWheelNames(names);
            setSpinningWheel(true);
            
            let count = 0;
            const spinDuration = 3000; // 3 seconds
            const intervalTime = 100; // Change name every 100ms
            const totalSpins = spinDuration / intervalTime;
            
            const interval = setInterval(() => {
              setCurrentWheelName(names[count % names.length].name);
              count++;
              
              if (count >= totalSpins) {
                clearInterval(interval);
                const winner = spinWheel(names);
                setCurrentWheelName(winner.name);
                
                setTimeout(() => {
                  setSpinningWheel(false);
                  callback(winner);
                }, 1000); // Show winner for 1 second
              }
            }, intervalTime);
          };

          const startEvent = async () => {
            const potentialCaptains = eventData.participants.filter(p => p.wantsCaptain);
            
            if (potentialCaptains.length < 2) {
              alert('Need at least 2 people willing to be captain!');
              return;
            }

            // First wheel spin for captain 1
            animateWheelSpin(potentialCaptains, (captain1) => {
              const remainingCaptains = potentialCaptains.filter(p => p.name !== captain1.name);
              
              // Second wheel spin for captain 2
              setTimeout(() => {
                animateWheelSpin(remainingCaptains, async (captain2) => {
                  const firstPicker = Math.random() < 0.5 ? 0 : 1;
                  
                  const selectedCaptains = [captain1, captain2];
                  const nonCaptains = eventData.participants.filter(
                    p => p.name !== captain1.name && p.name !== captain2.name
                  );

                  // Update event in Google Sheets with draft status
                  const updatedEventData = {
                    ...eventData,
                    started: true,
                    captains: selectedCaptains,
                    firstPicker: firstPicker,
                    currentPicker: firstPicker,
                    availablePlayers: nonCaptains,
                    teams: { captain1: [], captain2: [] },
                    deferredFirstPick: false
                  };

                  try {
                    const params = new URLSearchParams({
                      action: 'updateEvent',
                      eventId: eventId,
                      eventData: JSON.stringify(updatedEventData)
                    });

                    await fetch(`${SCRIPT_URL}?${params.toString()}`);
                    
                    setCaptains(selectedCaptains);
                    setPickingCaptain(firstPicker);
                    setAvailablePlayers(nonCaptains);
                    setTeams({ captain1: [], captain2: [] });
                    setView('captainChoice');
                  } catch (err) {
                    setError('Error starting event: ' + err.message);
                  }
                });
              }, 1500); // Pause between spins
            });
          };

          const deferFirstPick = async () => {
            setFirstPickerDeferred(true);
            
            // Swap who picks first in the draft
            const newCurrentPicker = pickingCaptain === 0 ? 1 : 0;
            setPickingCaptain(newCurrentPicker);
            
            // Update Google Sheets
            const updatedEventData = {
              ...eventData,
              deferredFirstPick: true,
              currentPicker: newCurrentPicker
            };

            try {
              const params = new URLSearchParams({
                action: 'updateEvent',
                eventId: eventId,
                eventData: JSON.stringify(updatedEventData)
              });

              await fetch(`${SCRIPT_URL}?${params.toString()}`);
              setEventData(updatedEventData);
              setView('teamPicking');
            } catch (err) {
              setError('Error deferring pick: ' + err.message);
            }
          };

          const startDrafting = () => {
            setDraftTimer(draftTimerSetting);
            setView('teamPicking');
          };

          const handleCaptainTimeout = async () => {
            // First captain timed out, ask second captain
            if (pickingCaptain === eventData.firstPicker) {
              const otherCaptain = pickingCaptain === 0 ? 1 : 0;
              setPickingCaptain(otherCaptain);
              setCaptainChoiceTimer(captainChoiceTimerSetting);
              
              // Update event data
              const updatedEventData = {
                ...eventData,
                currentPicker: otherCaptain,
                firstPickerTimedOut: true
              };
              
              try {
                const params = new URLSearchParams({
                  action: 'updateEvent',
                  eventId: eventId,
                  eventData: JSON.stringify(updatedEventData)
                });
                await fetch(`${SCRIPT_URL}?${params.toString()}`);
                setEventData(updatedEventData);
              } catch (err) {
                console.error('Error updating after timeout:', err);
              }
            } else {
              // Second captain also timed out, randomize
              const randomDefer = Math.random() < 0.5;
              if (randomDefer) {
                await deferFirstPick();
              } else {
                startDrafting();
              }
            }
          };

          const handleDraftTimeout = async () => {
            if (availablePlayers.length > 0 && !isAutoPicking) {
              setIsAutoPicking(true);
              // Auto-pick random player
              const randomPlayer = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];
              await pickPlayer(randomPlayer);
              setTimeout(() => setIsAutoPicking(false), 1000);
            }
          };

          // Captain choice timer
          useEffect(() => {
            if (view === 'captainChoice' && captainChoiceTimer > 0) {
              const timer = setTimeout(() => {
                setCaptainChoiceTimer(prev => prev - 1);
              }, 1000);
              return () => clearTimeout(timer);
            } else if (view === 'captainChoice' && captainChoiceTimer === 0) {
              handleCaptainTimeout();
            }
          }, [view, captainChoiceTimer]);

          // Draft timer
          useEffect(() => {
            if (view === 'teamPicking' && availablePlayers.length > 0 && draftTimer > 0 && !isAutoPicking) {
              const timer = setTimeout(() => {
                setDraftTimer(prev => prev - 1);
              }, 1000);
              return () => clearTimeout(timer);
            } else if (view === 'teamPicking' && draftTimer === 0 && availablePlayers.length > 0 && !isAutoPicking) {
              handleDraftTimeout();
            }
          }, [view, draftTimer, availablePlayers, isAutoPicking]);

          // Reset draft timer when picker changes
          useEffect(() => {
            if (view === 'teamPicking' && !isAutoPicking) {
              setDraftTimer(draftTimerSetting);
            }
          }, [pickingCaptain, view, teams.captain1.length, teams.captain2.length, draftTimerSetting]); // Reset when any team changes

          const pickPlayer = async (player) => {
            // Prevent double-clicking
            if (isDrafting) {
              return;
            }
            
            setIsDrafting(true);
            
            const teamKey = pickingCaptain === 0 ? 'captain1' : 'captain2';
            
            const newTeams = {
              ...teams,
              [teamKey]: [...teams[teamKey], player]
            };
            
            const newAvailablePlayers = availablePlayers.filter(p => p.name !== player.name);
            
            // Update local state immediately for smooth UI
            setTeams(newTeams);
            setAvailablePlayers(newAvailablePlayers);
            setDraftTimer(draftTimerSetting); // Reset to setting
            setJustDrafted(player.name); // Highlight drafted player
            setTimeout(() => setJustDrafted(null), 2000); // Clear after 2 seconds
            
            // Play draft sound
            try {
              const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
              audio.volume = 0.3;
              audio.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
              console.log('Audio creation failed:', e);
            }
            
            // Update Google Sheets in background
            const updatedEventData = {
              ...eventData,
              teams: newTeams,
              availablePlayers: newAvailablePlayers,
              currentPicker: pickingCaptain === 0 ? 1 : 0,
              teamNames: teamNames
            };

            try {
              const params = new URLSearchParams({
                action: 'updateEvent',
                eventId: eventId,
                eventData: JSON.stringify(updatedEventData)
              });

              await fetch(`${SCRIPT_URL}?${params.toString()}`);
              setEventData(updatedEventData);
            } catch (err) {
              console.error('Error updating teams:', err);
            }
            
            // Allow drafting again after a short delay
            setTimeout(() => {
              setIsDrafting(false);
            }, 500);
            
            // Check if all players are picked
            if (newAvailablePlayers.length === 1) {
              const otherTeamKey = pickingCaptain === 0 ? 'captain2' : 'captain1';
              const finalTeams = {
                ...newTeams,
                [otherTeamKey]: [...newTeams[otherTeamKey], newAvailablePlayers[0]]
              };
              
              setTeams(finalTeams);
              setAvailablePlayers([]);
              
              // Play final sound
              try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
                audio.volume = 0.5;
                audio.play().catch(e => console.log('Audio play failed:', e));
              } catch (e) {
                console.log('Audio creation failed:', e);
              }
              
              // Update Google Sheets with final teams
              const finalEventData = {
                ...eventData,
                teams: finalTeams,
                availablePlayers: [],
                completed: true,
                teamNames: teamNames
              };

              try {
                const params = new URLSearchParams({
                  action: 'updateEvent',
                  eventId: eventId,
                  eventData: JSON.stringify(finalEventData)
                });

                await fetch(`${SCRIPT_URL}?${params.toString()}`);
              } catch (err) {
                console.error('Error finalizing teams:', err);
              }
              
              setView('complete');
            } else {
              setPickingCaptain(prev => prev === 0 ? 1 : 0);
            }
          };

          const removePlayer = async (playerIndex) => {
            if (!confirm('Are you sure you want to kick this player?')) {
              return;
            }

            setLoading(true);
            setError('');

            try {
              const updatedEventData = { ...eventData };
              updatedEventData.participants.splice(playerIndex, 1);

              const params = new URLSearchParams({
                action: 'updateEvent',
                eventId: eventId,
                eventData: JSON.stringify(updatedEventData)
              });

              const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
              const result = await response.json();

              if (result.success) {
                setEventData(result.eventData);
              } else {
                setError('Failed to remove player: ' + result.error);
              }
            } catch (err) {
              setError('Error removing player: ' + err.message);
              console.error('Remove player error:', err);
            } finally {
              setLoading(false);
            }
          };

          const updatePlayerRoles = async (playerIndex, updates) => {
            setLoading(true);
            setError('');

            try {
              const updatedEventData = { ...eventData };
              updatedEventData.participants[playerIndex] = {
                ...updatedEventData.participants[playerIndex],
                ...updates
              };

              const params = new URLSearchParams({
                action: 'updateEvent',
                eventId: eventId,
                eventData: JSON.stringify(updatedEventData)
              });

              const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
              const result = await response.json();

              if (result.success) {
                setEventData(result.eventData);
                setEditingPlayer(null);
                setEditingRoles({});
                setTempRoles({});
              } else {
                setError('Failed to update player: ' + result.error);
              }
            } catch (err) {
              setError('Error updating player: ' + err.message);
              console.error('Update player error:', err);
            } finally {
              setLoading(false);
            }
          };

          const startEditingRoles = (playerIndex, participant) => {
            setEditingPlayer(playerIndex);
            setTempRoles({
              wantsCaptain: participant.wantsCaptain,
              lockpicker: participant.lockpicker,
              healer: participant.healer,
              bard: participant.bard
            });
          };

          const updateTeamName = async (teamKey) => {
            const newName = tempTeamName;
            const updatedTeamNames = { ...teamNames, [teamKey]: newName };
            setTeamNames(updatedTeamNames);
            
            try {
              const updatedEventData = {
                ...eventData,
                teamNames: updatedTeamNames
              };
              
              const params = new URLSearchParams({
                action: 'updateEvent',
                eventId: eventId,
                eventData: JSON.stringify(updatedEventData)
              });

              await fetch(`${SCRIPT_URL}?${params.toString()}`);
              setEventData(updatedEventData);
              setEditingTeamName(null);
              setTempTeamName('');
            } catch (err) {
              console.error('Error updating team name:', err);
            }
          };

          const startEditingTeamName = (teamKey) => {
            setEditingTeamName(teamKey);
            setTempTeamName(teamNames[teamKey] || '');
          };

          const getRoleIcons = (participant) => {
            const icons = [];
            if (participant.lockpicker) icons.push(<Key key="key" className="w-4 h-4 text-yellow-500" />);
            if (participant.healer) icons.push(<Heart key="heart" className="w-4 h-4 text-red-500" />);
            if (participant.bard) icons.push(<Music key="music" className="w-4 h-4 text-purple-500" />);
            return icons;
          };

          if (view === 'home') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-900 via-orange-800 to-red-900 p-8">
                <div className="max-w-2xl mx-auto">
                  {characterName && (
                    <div className="text-center mb-4">
                      <span className="bg-amber-600 text-white px-4 py-2 rounded-full text-sm">
                        Character: {characterName}
                      </span>
                    </div>
                  )}
                  <div className="bg-black/40 backdrop-blur-sm rounded-lg p-8 border-2 border-amber-600">
                    <div className="text-center mb-8">
                      <h1 className="text-5xl font-bold text-amber-400 mb-2">BEAR GUILD</h1>
                      <h2 className="text-2xl text-orange-300">Treasure Map Team Picker</h2>
                    </div>
                    
                    {error && (
                      <div className="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded mb-4">
                        {error}
                      </div>
                    )}
                    
                    <div className="space-y-4">
                      <button onClick={() => setView('create')} className="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 px-6 rounded-lg transition-colors text-xl">
                        Create New Event
                      </button>
                      <button onClick={() => setView('join')} className="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 px-6 rounded-lg transition-colors text-xl">
                        Join Existing Event
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'create') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-900 via-orange-800 to-red-900 p-8">
                <div className="max-w-2xl mx-auto">
                  <div className="bg-black/40 backdrop-blur-sm rounded-lg p-8 border-2 border-amber-600">
                    <h2 className="text-3xl font-bold text-amber-400 mb-6">Create Event</h2>
                    
                    {error && (
                      <div className="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded mb-4">
                        {error}
                      </div>
                    )}
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-orange-300 mb-2">Your Character Name</label>
                        <input type="text" value={characterName} onChange={(e) => setCharacterName(e.target.value)} className="w-full px-4 py-2 bg-black/60 border border-amber-600 rounded text-white" placeholder="Enter your name" />
                      </div>
                      
                      <div className="space-y-2">
                        <label className="block text-orange-300 mb-2">Your Roles</label>
                        <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                          <input type="checkbox" checked={wantsCaptain} onChange={(e) => setWantsCaptain(e.target.checked)} className="w-5 h-5" />
                          <Shield className="w-5 h-5" />
                          I want to be a Captain
                        </label>
                        <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                          <input type="checkbox" checked={isLockpicker} onChange={(e) => setIsLockpicker(e.target.checked)} className="w-5 h-5" />
                          <Key className="w-5 h-5 text-yellow-500" />
                          Lockpicker
                        </label>
                        <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                          <input type="checkbox" checked={isHealer} onChange={(e) => setIsHealer(e.target.checked)} className="w-5 h-5" />
                          <Heart className="w-5 h-5 text-red-500" />
                          Healer
                        </label>
                        <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                          <input type="checkbox" checked={isBard} onChange={(e) => setIsBard(e.target.checked)} className="w-5 h-5" />
                          <Music className="w-5 h-5 text-purple-500" />
                          Bard
                        </label>
                      </div>
                      
                      <div className="flex gap-4">
                        <button onClick={createEvent} disabled={!characterName.trim() || loading} className="flex-1 bg-amber-600 hover:bg-amber-700 disabled:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                          {loading ? 'Creating...' : 'Create Event'}
                        </button>
                        <button onClick={() => setView('home')} disabled={loading} className="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'join') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-900 via-orange-800 to-red-900 p-8">
                <div className="max-w-2xl mx-auto">
                  <div className="bg-black/40 backdrop-blur-sm rounded-lg p-8 border-2 border-amber-600">
                    <h2 className="text-3xl font-bold text-amber-400 mb-6">Join Event</h2>
                    
                    {error && (
                      <div className="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded mb-4">
                        {error}
                      </div>
                    )}
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-orange-300 mb-2">Event ID</label>
                        <input type="text" value={eventId} onChange={(e) => setEventId(e.target.value.toUpperCase())} className="w-full px-4 py-2 bg-black/60 border border-amber-600 rounded text-white uppercase" placeholder="Enter event ID" />
                      </div>
                      <div>
                        <label className="block text-orange-300 mb-2">Your Character Name</label>
                        <input type="text" value={characterName} onChange={(e) => setCharacterName(e.target.value)} className="w-full px-4 py-2 bg-black/60 border border-amber-600 rounded text-white" placeholder="Enter your name" />
                      </div>
                      <div className="space-y-2">
                        <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                          <input type="checkbox" checked={wantsCaptain} onChange={(e) => setWantsCaptain(e.target.checked)} className="w-5 h-5" />
                          <Shield className="w-5 h-5" />
                          I want to be a Captain
                        </label>
                        <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                          <input type="checkbox" checked={isLockpicker} onChange={(e) => setIsLockpicker(e.target.checked)} className="w-5 h-5" />
                          <Key className="w-5 h-5 text-yellow-500" />
                          Lockpicker
                        </label>
                        <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                          <input type="checkbox" checked={isHealer} onChange={(e) => setIsHealer(e.target.checked)} className="w-5 h-5" />
                          <Heart className="w-5 h-5 text-red-500" />
                          Healer
                        </label>
                        <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                          <input type="checkbox" checked={isBard} onChange={(e) => setIsBard(e.target.checked)} className="w-5 h-5" />
                          <Music className="w-5 h-5 text-purple-500" />
                          Bard
                        </label>
                      </div>
                      <div className="flex gap-4">
                        <button onClick={joinEvent} disabled={!characterName.trim() || !eventId.trim() || loading} className="flex-1 bg-amber-600 hover:bg-amber-700 disabled:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                          {loading ? 'Joining...' : 'Join Event'}
                        </button>
                        <button onClick={() => setView('home')} disabled={loading} className="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'lobby') {
            const isMarshall = eventData?.participants?.[0]?.name === characterName;
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-900 via-orange-800 to-red-900 p-8">
                <div className="max-w-4xl mx-auto">
                  {characterName && (
                    <div className="text-center mb-4">
                      <span className="bg-amber-600 text-white px-4 py-2 rounded-full text-sm">
                        Character: {characterName}
                      </span>
                    </div>
                  )}
                  
                  {/* Wheel Spin Modal */}
                  {spinningWheel && (
                    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
                      <div className="bg-gradient-to-br from-amber-900 via-orange-800 to-red-900 p-12 rounded-lg border-4 border-amber-600 text-center">
                        <h2 className="text-4xl font-bold text-amber-400 mb-8">Spinning the Wheel!</h2>
                        <div className="w-64 h-64 mx-auto mb-8 bg-amber-600 rounded-full flex items-center justify-center border-8 border-amber-400 animate-spin">
                          <div className="bg-black/60 w-48 h-48 rounded-full flex items-center justify-center">
                            <span className="text-white text-3xl font-bold">{currentWheelName}</span>
                          </div>
                        </div>
                        <p className="text-orange-300 text-xl">Selecting Captain...</p>
                      </div>
                    </div>
                  )}
                  
                  <div className="bg-black/40 backdrop-blur-sm rounded-lg p-8 border-2 border-amber-600">
                    <div className="flex justify-between items-center mb-6">
                      <h2 className="text-3xl font-bold text-amber-400">Event Lobby</h2>
                      <div className="text-right">
                        <div className="text-orange-300 text-sm">Event ID</div>
                        <div className="text-2xl font-bold text-white">{eventId}</div>
                        {eventData?.started && (
                          <div className="text-red-400 text-sm mt-1">🔒 LOCKED</div>
                        )}
                      </div>
                    </div>
                    <button onClick={copyEventLink} className="w-full mb-6 bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
                      {linkCopied ? (<><Check className="w-5 h-5" />Link Copied!</>) : (<><Copy className="w-5 h-5" />Copy Event Link</>)}
                    </button>
                    <div className="mb-6">
                      <h3 className="text-xl text-orange-300 mb-4 flex items-center gap-2">
                        <Users className="w-6 h-6" />
                        Participants ({eventData?.participants?.length || 0})
                      </h3>
                      <div className="space-y-2">
                        {eventData?.participants?.map((p, idx) => (
                          <div key={idx} className="bg-black/60 p-4 rounded border border-amber-600">
                            {editingPlayer === idx ? (
                              <div className="space-y-3">
                                <div className="flex justify-between items-center mb-2">
                                  <span className="text-white font-bold">{p.name}</span>
                                  <button onClick={() => { setEditingPlayer(null); setTempRoles({}); }} className="text-gray-400 hover:text-white">Cancel</button>
                                </div>
                                <div className="space-y-2">
                                  <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                                    <input type="checkbox" checked={tempRoles.wantsCaptain} onChange={(e) => setTempRoles({ ...tempRoles, wantsCaptain: e.target.checked })} className="w-5 h-5" />
                                    <Shield className="w-5 h-5" />
                                    Wants to be Captain
                                  </label>
                                  <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                                    <input type="checkbox" checked={tempRoles.lockpicker} onChange={(e) => setTempRoles({ ...tempRoles, lockpicker: e.target.checked })} className="w-5 h-5" />
                                    <Key className="w-5 h-5 text-yellow-500" />
                                    Lockpicker
                                  </label>
                                  <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                                    <input type="checkbox" checked={tempRoles.healer} onChange={(e) => setTempRoles({ ...tempRoles, healer: e.target.checked })} className="w-5 h-5" />
                                    <Heart className="w-5 h-5 text-red-500" />
                                    Healer
                                  </label>
                                  <label className="flex items-center gap-2 text-orange-300 cursor-pointer">
                                    <input type="checkbox" checked={tempRoles.bard} onChange={(e) => setTempRoles({ ...tempRoles, bard: e.target.checked })} className="w-5 h-5" />
                                    <Music className="w-5 h-5 text-purple-500" />
                                    Bard
                                  </label>
                                </div>
                                <button 
                                  onClick={() => updatePlayerRoles(idx, tempRoles)}
                                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors"
                                >
                                  Save Changes
                                </button>
                              </div>
                            ) : (
                              <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                  <span className="text-white font-bold">{p.name}</span>
                                  {p.isMarshall && <span className="bg-purple-600 text-white text-xs px-2 py-1 rounded">MARSHALL</span>}
                                  {p.wantsCaptain && <span className="bg-amber-600 text-white text-xs px-2 py-1 rounded flex items-center gap-1"><Shield className="w-3 h-3" />CAPTAIN</span>}
                                </div>
                                <div className="flex items-center gap-3">
                                  <div className="flex gap-2">{getRoleIcons(p)}</div>
                                  {isMarshall && (
                                    <div className="flex gap-2">
                                      <button onClick={() => startEditingRoles(idx, p)} className="text-orange-300 hover:text-orange-400 p-1" title="Edit roles">
                                        <Edit className="w-4 h-4" />
                                      </button>
                                      {!p.isMarshall && (
                                        <button onClick={() => removePlayer(idx)} className="text-red-400 hover:text-red-500 p-1" title="Kick player">
                                          <Trash className="w-4 h-4" />
                                        </button>
                                      )}
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                    {isMarshall && !eventData?.started && (
                      <div className="mb-6 bg-purple-900/40 p-4 rounded border border-purple-600">
                        <h3 className="text-lg text-purple-300 mb-3 font-bold">⚙️ Timer Settings</h3>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-purple-200 text-sm mb-2">
                              Captain Choice Timer (10-300s)
                            </label>
                            <input 
                              type="number" 
                              min="10" 
                              max="300"
                              value={captainChoiceTimerSetting}
                              onChange={(e) => setCaptainChoiceTimerSetting(parseInt(e.target.value) || 45)}
                              className="w-full px-3 py-2 bg-black/60 border border-purple-600 rounded text-white"
                            />
                            <p className="text-purple-300 text-xs mt-1">Currently: {captainChoiceTimerSetting}s</p>
                          </div>
                          <div>
                            <label className="block text-purple-200 text-sm mb-2">
                              Draft Timer (10-300s)
                            </label>
                            <input 
                              type="number" 
                              min="10" 
                              max="300"
                              value={draftTimerSetting}
                              onChange={(e) => setDraftTimerSetting(parseInt(e.target.value) || 60)}
                              className="w-full px-3 py-2 bg-black/60 border border-purple-600 rounded text-white"
                            />
                            <p className="text-purple-300 text-xs mt-1">Currently: {draftTimerSetting}s</p>
                          </div>
                        </div>
                      </div>
                    )}
                    {isMarshall && !eventData?.started && (
                      <button onClick={startEvent} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition-colors text-xl">
                        Start Event
                      </button>
                    )}
                    {eventData?.started && (
                      <div className="bg-gray-900/60 p-4 rounded border-2 border-gray-500 text-center">
                        <p className="text-gray-300 text-lg">Event has started! Selecting captains...</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          // Captain Choice View - First picker decides to pick first or defer
          if (view === 'captainChoice') {
            const isFirstCaptain = captains[pickingCaptain]?.name === characterName;
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-900 via-orange-800 to-red-900 p-8">
                <div className="max-w-4xl mx-auto">
                  {characterName && (
                    <div className="text-center mb-4">
                      <span className="bg-amber-600 text-white px-4 py-2 rounded-full text-sm">
                        Character: {characterName}
                      </span>
                    </div>
                  )}
                  <div className="bg-black/40 backdrop-blur-sm rounded-lg p-8 border-2 border-amber-600">
                    <h2 className="text-4xl font-bold text-amber-400 mb-8 text-center">Captains Selected!</h2>
                    
                    <div className="grid grid-cols-2 gap-8 mb-8">
                      <div className="bg-blue-900/60 p-6 rounded border-2 border-blue-500 text-center">
                        <Shield className="w-16 h-16 mx-auto mb-4 text-blue-300" />
                        <h3 className="text-2xl text-blue-300 font-bold">{captains[0]?.name}</h3>
                        <p className="text-blue-200 mt-2">Team 1 Captain</p>
                      </div>
                      
                      <div className="bg-red-900/60 p-6 rounded border-2 border-red-500 text-center">
                        <Shield className="w-16 h-16 mx-auto mb-4 text-red-300" />
                        <h3 className="text-2xl text-red-300 font-bold">{captains[1]?.name}</h3>
                        <p className="text-red-200 mt-2">Team 2 Captain</p>
                      </div>
                    </div>
                    
                    {isFirstCaptain ? (
                      <div className="bg-green-900/60 p-8 rounded border-2 border-green-500">
                        <div className="text-center mb-4">
                          <div className="text-6xl font-bold text-yellow-400 mb-2">{captainChoiceTimer}</div>
                          <p className="text-yellow-200">seconds remaining</p>
                        </div>
                        <h3 className="text-3xl text-green-300 font-bold mb-4 text-center">You Pick First!</h3>
                        <p className="text-green-200 text-center mb-6">
                          You can pick your team first, or defer to pick the first treasure map later.
                        </p>
                        <div className="grid grid-cols-2 gap-4">
                          <button 
                            onClick={startDrafting}
                            className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition-colors"
                          >
                            Pick Team First
                          </button>
                          <button 
                            onClick={deferFirstPick}
                            className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 px-6 rounded-lg transition-colors"
                          >
                            Defer (Pick Map First Later)
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div className="bg-gray-900/60 p-8 rounded border-2 border-gray-500 text-center">
                        <div className="text-6xl font-bold text-yellow-400 mb-4">{captainChoiceTimer}</div>
                        <h3 className="text-2xl text-gray-300 mb-4">Waiting for {captains[pickingCaptain]?.name}</h3>
                        <p className="text-gray-400">
                          {captains[pickingCaptain]?.name} is deciding whether to pick their team first or defer...
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'teamPicking') {
            const isCurrentCaptain = captains[pickingCaptain]?.name === characterName;
            const isCaptain1 = captains[0]?.name === characterName;
            const isCaptain2 = captains[1]?.name === characterName;
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-900 via-orange-800 to-red-900 p-8">
                <div className="max-w-6xl mx-auto">
                  {characterName && (
                    <div className="text-center mb-4">
                      <span className="bg-amber-600 text-white px-4 py-2 rounded-full text-sm">
                        Character: {characterName}
                      </span>
                    </div>
                  )}
                  <div className="bg-black/40 backdrop-blur-sm rounded-lg p-8 border-2 border-amber-600">
                    <h2 className="text-3xl font-bold text-amber-400 mb-6 text-center">Team Selection</h2>
                    
                    {availablePlayers.length > 0 && (
                      <div className="text-center mb-4">
                        <div className={`inline-block px-6 py-3 rounded-lg ${draftTimer <= 10 ? 'bg-red-600 animate-pulse' : 'bg-yellow-600'}`}>
                          <span className="text-white text-2xl font-bold">{draftTimer}s</span>
                          <span className={`ml-2 ${draftTimer <= 10 ? 'text-red-200' : 'text-yellow-200'}`}>to pick</span>
                        </div>
                      </div>
                    )}
                    
                    {isAutoPicking && (
                      <div className="bg-red-600/80 p-4 rounded border-2 border-red-400 mb-6 text-center">
                        <p className="text-white text-xl font-bold">⏰ Time's up! Auto-picking random player...</p>
                      </div>
                    )}
                    
                    {isCurrentCaptain && availablePlayers.length > 0 && (
                      <div className="bg-green-900/60 p-4 rounded border-2 border-green-500 mb-6 text-center">
                        <p className="text-green-200 text-xl font-bold">It's your turn to pick!</p>
                      </div>
                    )}
                    
                    {!isCurrentCaptain && availablePlayers.length > 0 && (
                      <div className="bg-gray-900/60 p-4 rounded border-2 border-gray-500 mb-6 text-center">
                        <p className="text-gray-300 text-xl">Waiting for {captains[pickingCaptain]?.name} to pick...</p>
                      </div>
                    )}
                    
                    <div className="grid grid-cols-3 gap-4 mb-6">
                      <div className="bg-blue-900/60 p-4 rounded border-2 border-blue-500">
                        {editingTeamName === 'captain1' && isCaptain1 ? (
                          <div className="mb-3">
                            <input
                              type="text"
                              value={teamNames.captain1}
                              onChange={(e) => setTeamNames({ ...teamNames, captain1: e.target.value })}
                              onBlur={() => updateTeamName('captain1', teamNames.captain1)}
                              onKeyPress={(e) => e.key === 'Enter' && updateTeamName('captain1', teamNames.captain1)}
                              className="w-full px-2 py-1 bg-black/60 border border-blue-400 rounded text-white text-lg"
                              placeholder="Team name..."
                              autoFocus
                            />
                          </div>
                        ) : (
                          <h3 className="text-xl text-blue-300 mb-3 flex items-center gap-2">
                            <Shield className="w-5 h-5" />
                            {teamNames.captain1 || `Team 1: ${captains[0]?.name}`}
                            {isCaptain1 && (
                              <button 
                                onClick={() => setEditingTeamName('captain1')}
                                className="text-blue-400 hover:text-blue-300 ml-auto"
                              >
                                <Edit className="w-4 h-4" />
                              </button>
                            )}
                          </h3>
                        )}
                        <div className="space-y-2">
                          {teams.captain1.map((p, idx) => (
                            <div 
                              key={idx} 
                              className={`bg-black/60 p-2 rounded text-white flex justify-between items-center transition-all ${
                                justDrafted === p.name ? 'ring-4 ring-green-400 bg-green-900/60 scale-105' : ''
                              }`}
                            >
                              <span>{p.name}</span>
                              <div className="flex gap-1">{getRoleIcons(p)}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      <div className="bg-black/60 p-4 rounded border-2 border-amber-600">
                        <h3 className="text-xl text-orange-300 mb-3 text-center">Available Players</h3>
                        {availablePlayers.length === 0 ? (
                          <div className="text-center text-gray-400">All picked!</div>
                        ) : (
                          <div className="space-y-2">
                            {availablePlayers.map((p, idx) => (
                              <button 
                                key={idx} 
                                onClick={() => isCurrentCaptain && !isDrafting ? pickPlayer(p) : null}
                                disabled={!isCurrentCaptain || isDrafting}
                                className={`w-full p-2 rounded text-white flex justify-between items-center transition-colors ${
                                  isCurrentCaptain && !isDrafting
                                    ? 'bg-amber-600 hover:bg-amber-700 cursor-pointer' 
                                    : 'bg-gray-700 cursor-not-allowed opacity-50'
                                }`}
                              >
                                <span>{p.name}</span>
                                <div className="flex gap-1">{getRoleIcons(p)}</div>
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                      
                      <div className="bg-red-900/60 p-4 rounded border-2 border-red-500">
                        {editingTeamName === 'captain2' && isCaptain2 ? (
                          <div className="mb-3">
                            <input
                              type="text"
                              value={teamNames.captain2}
                              onChange={(e) => setTeamNames({ ...teamNames, captain2: e.target.value })}
                              onBlur={() => updateTeamName('captain2', teamNames.captain2)}
                              onKeyPress={(e) => e.key === 'Enter' && updateTeamName('captain2', teamNames.captain2)}
                              className="w-full px-2 py-1 bg-black/60 border border-red-400 rounded text-white text-lg"
                              placeholder="Team name..."
                              autoFocus
                            />
                          </div>
                        ) : (
                          <h3 className="text-xl text-red-300 mb-3 flex items-center gap-2">
                            <Shield className="w-5 h-5" />
                            {teamNames.captain2 || `Team 2: ${captains[1]?.name}`}
                            {isCaptain2 && (
                              <button 
                                onClick={() => setEditingTeamName('captain2')}
                                className="text-red-400 hover:text-red-300 ml-auto"
                              >
                                <Edit className="w-4 h-4" />
                              </button>
                            )}
                          </h3>
                        )}
                        <div className="space-y-2">
                          {teams.captain2.map((p, idx) => (
                            <div 
                              key={idx} 
                              className={`bg-black/60 p-2 rounded text-white flex justify-between items-center transition-all ${
                                justDrafted === p.name ? 'ring-4 ring-green-400 bg-green-900/60 scale-105' : ''
                              }`}
                            >
                              <span>{p.name}</span>
                              <div className="flex gap-1">{getRoleIcons(p)}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'complete') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-900 via-orange-800 to-red-900 p-8">
                <div className="max-w-6xl mx-auto">
                  {characterName && (
                    <div className="text-center mb-4">
                      <span className="bg-amber-600 text-white px-4 py-2 rounded-full text-sm">
                        Character: {characterName}
                      </span>
                    </div>
                  )}
                  <div className="bg-black/40 backdrop-blur-sm rounded-lg p-8 border-2 border-amber-600">
                    <h2 className="text-4xl font-bold text-amber-400 mb-8 text-center">Teams Ready!</h2>
                    <div className="grid grid-cols-2 gap-8 mb-8">
                      <div className="bg-blue-900/60 p-6 rounded border-2 border-blue-500">
                        <h3 className="text-2xl text-blue-300 mb-4 flex items-center gap-2">
                          <Shield className="w-6 h-6" />
                          {eventData?.teamNames?.captain1 || `Team 1: ${captains[0]?.name}`}
                        </h3>
                        <div className="space-y-2">
                          <div className="bg-blue-800/60 p-3 rounded text-white font-bold">
                            {captains[0]?.name} (Captain)
                          </div>
                          {teams.captain1.map((p, idx) => (
                            <div key={idx} className="bg-black/60 p-3 rounded text-white flex justify-between items-center">
                              <span>{p.name}</span>
                              <div className="flex gap-1">{getRoleIcons(p)}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="bg-red-900/60 p-6 rounded border-2 border-red-500">
                        <h3 className="text-2xl text-red-300 mb-4 flex items-center gap-2">
                          <Shield className="w-6 h-6" />
                          {eventData?.teamNames?.captain2 || `Team 2: ${captains[1]?.name}`}
                        </h3>
                        <div className="space-y-2">
                          <div className="bg-red-800/60 p-3 rounded text-white font-bold">
                            {captains[1]?.name} (Captain)
                          </div>
                          {teams.captain2.map((p, idx) => (
                            <div key={idx} className="bg-black/60 p-3 rounded text-white flex justify-between items-center">
                              <span>{p.name}</span>
                              <div className="flex gap-1">{getRoleIcons(p)}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                    <div className="text-center mb-8">
                      <div className="text-6xl font-bold text-amber-400 mb-2">Ready to Hunt!</div>
                      <div className="text-xl text-orange-300">Good luck with your treasure maps!</div>
                      {eventData?.deferredFirstPick && (
                        <div className="mt-4 bg-purple-900/60 p-4 rounded border-2 border-purple-500">
                          <p className="text-purple-200 text-lg">
                            <strong>{captains[eventData.firstPicker]?.name}</strong> deferred and will pick the first treasure map!
                          </p>
                        </div>
                      )}
                    </div>
                    <div className="flex justify-end">
                      <button onClick={() => setView('home')} className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg transition-colors text-xl">
                        OK
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          return null;
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TreasureMapTeamPicker />);
    </script>
</body>
</html>